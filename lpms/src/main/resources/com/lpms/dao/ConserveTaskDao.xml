<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lpms.dao.ConserveTaskDao">

    <resultMap id="ConserveTaskResultMap" type="com.lpms.pojo.conserveTask.ConserveTask">
        <id property="conserveTaskId" column="conserveTask_id" />
        <result property="conserveTaskName" column="conserveTask_name" />
        <result property="conserveTaskDescribe" column="conserveTask_describe" />
        <result property="conserveTaskPlace" column="conserveTask_place" />
        <result property="conserveTaskRequiretime" column="conserveTask_requiretime" />
        <result property="conserveTaskCompletetime" column="conserveTask_completetime" />
        <result property="conserveTaskCreatetime" column="conserveTask_createtime" />
        <result property="conserveTaskUpdatetime" column="conserveTask_updatetime" />

        <!-- 一对一级联查询与User -->
        <association property="user" column="conserveTask_peopleid" javaType="com.lpms.pojo.User" select="com.lpms.dao.UserDAO.getUserById">
            <result column="user_name" property="userName"/>
        </association>

        <collection property="plant" ofType="com.lpms.pojo.plant.Plant" column="conserveTask_id" select="com.lpms.dao.PlantDao.getPlantsByConserveTaskId">
            <result column="plant_name" property="plantName"/>
        </collection>

    </resultMap>

    <!-- 通过ID获取ConserveTask的查询语句 -->
    <select id="getConserveTaskById" resultMap="ConserveTaskResultMap">
        SELECT * FROM conserve_task WHERE conserveTask_id = #{conserveTaskId}
    </select>

    <!-- 通过用户名获取相关的ConserveTask的查询语句 -->
    <select id="getConserveTaskByUserName" resultMap="ConserveTaskResultMap" parameterType="String">
        SELECT ct.*
        FROM conserve_task ct
                 JOIN user u ON ct.conserveTask_peopleid = u.user_id
        WHERE u.user_name = #{username}
    </select>

    <!-- 通过ID获取ConserveTask的查询语句 -->
    <select id="getConserveTaskByName" resultMap="ConserveTaskResultMap">
        SELECT * FROM conserve_task WHERE conserveTask_name = #{conserveTaskName}
    </select>

    <!-- 查询所有ConserveTask的查询语句 -->
    <select id="getAllConserveTasks" resultMap="ConserveTaskResultMap">
        SELECT * FROM conserve_task
    </select>

    <!-- 添加新的ConserveTask的插入语句 -->
    <insert id="insertConserveTask" parameterType="com.lpms.pojo.conserveTask.ConserveTask" useGeneratedKeys="true" keyProperty="conserveTask_id">
        INSERT INTO conserve_task (conserveTask_name, conserveTask_describe, conserveTask_peopleid, conserveTask_place,
                                   conserveTask_requiretime, conserveTask_completetime,
                                   conserveTask_createtime, conserveTask_updatetime)
        VALUES (#{conserveTaskName}, #{conserveTaskDescribe}, #{user.userId}, #{conserveTaskPlace},
                #{conserveTaskRequiretime}, #{conserveTaskCompletetime},
                #{conserveTaskCreatetime}, #{conserveTaskUpdatetime})
    </insert>

    <insert id="insertPlantTaskRelation">
        INSERT INTO plant_task (plant_id, conserveTask_id)
        VALUES (#{plantId}, #{conserveTaskId})
    </insert>

    <!-- 修改现有ConserveTask的更新语句 -->
    <update id="updateConserveTask" parameterType="com.lpms.pojo.conserveTask.ConserveTask">
        UPDATE conserve_task SET
                                 conserveTask_name = #{conserveTaskName},
                                 conserveTask_describe = #{conserveTaskDescribe},
                                 conserveTask_peopleid = #{user.userId},
                                 conserveTask_place = #{conserveTaskPlace},
                                 conserveTask_requiretime = #{conserveTaskRequiretime},
                                 conserveTask_completetime = #{conserveTaskCompletetime},
                                 conserveTask_updatetime = #{conserveTaskUpdatetime}
        WHERE conserveTask_id = #{conserveTaskId}
    </update>

    <!-- 通过ID删除ConserveTask的删除语句 -->
    <delete id="deleteConserveTask" parameterType="int">
        DELETE FROM conserve_task WHERE conserveTask_id = #{conserveTaskId}
    </delete>

</mapper>
